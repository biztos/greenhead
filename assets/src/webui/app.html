<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Greenhead Simple Chat</title>
    <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function y(e){const t=i(e);t.classList.add("flash"),setTimeout(()=>{t.classList.remove("flash")},100)}function f(e){i(e).classList.add("hidden")}function d(e){i(e).classList.remove("hidden")}function i(e){if(typeof e=="string"){const t=document.querySelector(e);if(t===null)throw new Error(`Element not found by selector: ${e}`);return t}else return e}function m(e){const t=i(e);t.disabled=!0}function u(e){const t=i(e);t.disabled=!1}class h{id;name;description;constructor(t,n,o){this.id=t,this.name=n,this.description=o}static fromJSON(t){const n=JSON.parse(t);if(!n.id)throw new Error("Missing required property: id");if(!n.name)throw new Error("Missing required property: name");if(!n.description)throw new Error("Missing required property: description");return new h(n.id,n.name,n.description)}}class l{static _instance;api_key;name;agent_names;static initFromDOM(){const t=document.querySelector("#user-api-key"),n=i("#user-name"),o=i("#user-agent-name");let r=[];for(const s of Array.from(o.children)){const c=s;r.push(c.value)}return new l(t.value,n.value,r)}constructor(t,n,o){if(l._instance)throw new Error("Error: User singleton already initialized.");this.api_key=t,this.name=n,this.agent_names=o,l._instance=this}static getInstance(){if(!l._instance)throw new Error("Error: User singleton not initialized.");return l._instance}}class a{static _instance;user;agent;xhr;static initFromDOM(){const t=l.initFromDOM();return new a(t)}constructor(t){if(a._instance)throw new Error("Error: API singleton already initialized.");this.user=t,a._instance=this}static getInstance(){if(!a._instance)throw new Error("Error: API singleton not initialized.");return a._instance}}function w(){if(document.querySelector("#user-session")==null){p("Session not initiated.","Did you load from dist?"),f("#error-dismiss-button");return}const e=a.initFromDOM();let t=i("#newchat-agent-select");e.user.agent_names.forEach(n=>{let o=document.createElement("option");o.value=n,o.innerText=n,t.appendChild(o)}),i("#greeting").innerText=`Hello, ${e.user.name}!`,i("#prompt").addEventListener("focus",function(){this.select()}),i("#prompt").addEventListener("keydown",x),i("#error-dismiss-button").addEventListener("click",L),i("#newchat-button").addEventListener("click",E),i("#reset-key-button").addEventListener("click",T),d("#newchat")}async function E(){const e=a.getInstance();e.xhr?.abort(),e.xhr=void 0,f("#chat"),m("#newchat-agent-select"),m("#newchat-button");const n=i("#newchat-agent-select").value;try{S();const o=await fetch("/v1/agents/new",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.user.api_key},body:JSON.stringify({agent:n})});if(u("#newchat-agent-select"),u("#newchat-button"),g(),!o.ok){e.agent!=null&&d("#chat");const c=await o.text();p(`${o.status} ${o.statusText}`,c);return}const r=await o.json();console.log(typeof r),console.log(r);const s=new h(r.id,r.name,r.description);e.agent=s,v(s)}catch(o){u("#newchat-agent-select"),u("#newchat-button"),g(),p("Request failed",o instanceof Error?o.message:String(o))}}function v(e){i("#history").innerHTML="";const t=document.createElement("div");t.classList.add("system"),e.description==""?t.innerText=`You are chatting with ${e.name}.`:t.innerText=`You are chatting with ${e.name}: ${e.description}.`,i("#history").appendChild(t),d("#chat")}function T(e){e.preventDefault(),confirm("Clear chat history and reset API Key?")==!0&&(window.location.href="/v1/ui")}function p(e,t){i("#error-message").innerText=e,i("#error-detail").innerText=t,d("#error")}function L(){i("#error-message").innerText="Error.",i("#error-detail").innerText="An error occurred.",f("#error")}function b(e){e.style.height="auto";const t=window.getComputedStyle(e),n=parseFloat(t.paddingTop),o=parseFloat(t.paddingBottom),r=n+o;e.style.height=e.scrollHeight-r+"px",e.style.height=e.scrollHeight+10+"px"}function x(e){if(e.defaultPrevented)return;let t=e.target;if(b(t),e.key==="Enter"&&!e.shiftKey){e.preventDefault();let n=t.value;if(!n.match(/\S/)){y(t);return}O(n)}}function O(e){console.log("SEND PROMPT"),console.log(e)}function S(){d("#progress");let e=i("#spinner"),t=3;e.style.transformOrigin="center",e.style.animation=`spin ${t}s linear infinite`}function g(){f("#progress");let e=i("#spinner");const n=window.getComputedStyle(e).getPropertyValue("transform");e.style.animation="none",n!=="none"&&(e.style.transform=n)}document.addEventListener("DOMContentLoaded",w);</script>
    <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;display:flex;min-height:100vh;padding-top:10px;text-align:center}#main-content{min-width:60%;margin:0 auto}#prompt-entry{margin-top:20px}#prompt-entry label{font-weight:700;font-size:1.2em;margin-top:11px;margin-right:5px;display:inline-block;vertical-align:top}#prompt{resize:none;overflow:hidden;width:70%;height:auto;min-height:40px;font:sans-serif;font-size:1.2em;text-align:left;padding:10px;display:inline-block;vertical-align:top;background:#eee;border:1px solid black;margin-bottom:10px}#prompt.flash{border:1px solid red;background:#ffc}#prompt[contenteditable=false]{background:#ccc;color:#666}#progress{margin:20px auto}#history{width:60%;margin:20px auto}#history div{text-align:left;font-size:1.2em}#history div.system{color:red;font-style:italic}#history div.prompt{color:#00f}#history div.prompt{color:rust}#newchat{margin:20px auto;font-size:1.2em;border-top:2px solid black;padding-top:20px}select,::picker(select){appearance:base-select}select{font-size:1em;padding-left:5px;padding-right:5px}button{font-size:inherit;padding-left:5px;padding-right:5px;margin-left:10px}.hidden{display:none}#error{background:#ffc;color:red;border:4px solid black;width:50%;text-align:left;margin:0 auto;padding:10px}#error-controls{text-align:right}#error-detail{color:#000;margin-top:10px;font-size:1.2em;white-space:pre}#error-dismiss-button{font-size:inherit;padding-left:5px;padding-right:5px;margin-left:10px}#reset-key{margin:20px auto}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}</style>
  </head>
  <body>
    <!-- Main Content -->
    <div id="main-content">
      <h1>Greenhead Simple Chat</h1>
      <h2 id="greeting"></h2>
      <div id="error" class="hidden">
        <h2 id="error-message">Error</h2>
        <div id="error-detail">An error occurred.</div>
        <div id="error-controls">
          <button id="error-dismiss-button">Dismiss</button>
        </div>
      </div>
      <div id="chat" class="hidden">
        <div id="history"></div>
        <div id="prompt-entry">
          <label for="prompt">Prompt:</label>
          <textarea id="prompt">You're in a desert, walking along in the sand when all of the sudden you look down and you see a tortoise.</textarea>
          <p>
            Press <strong>Return</strong> to send;
            <strong>Shift-Return</strong> for newline.
          </p>
        </div>
      </div>
      <div id="newchat" class="hidden">
        Choose agent:
        <select id="newchat-agent-select"></select>
        <button id="newchat-button">New Chat</button>
      </div>
      <div id="reset-key">
        <button id="reset-key-button">Reset API Key</button>
      </div>
      <div id="progress" class="hidden">
        <svg
          id="spinner"
          width="50"
          height="50"
          viewBox="0 0 100 100"
          xmlns="http://www.w3.org/2000/svg"
        >
          <!-- Outer circle -->
          <circle
            cx="50"
            cy="50"
            r="45"
            fill="white"
            stroke="black"
            stroke-width="2"
          />

          <!-- Main halves -->
          <path
            d="M50,5 A45,45 0 0,0 50,95 A22.5,22.5 0 0,1 50,50 A22.5,22.5 0 0,0 50,5"
            fill="black"
          />

          <!-- Small circles -->
          <circle cx="50" cy="27.5" r="5" fill="white" />
          <circle cx="50" cy="72.5" r="5" fill="black" />
        </svg>
      </div>
    </div>
  </body>
</html>
