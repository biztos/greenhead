<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Greenhead Simple Chat</title>
    <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();function C(t){const e=o(t);e.classList.add("flash"),setTimeout(()=>{e.classList.remove("flash")},100)}function g(t){o(t).classList.add("hidden")}function f(t){o(t).classList.remove("hidden")}function o(t){if(typeof t=="string"){const e=document.querySelector(t);if(e===null)throw new Error(`Element not found by selector: ${t}`);return e}else return t}function u(t){const e=o(t);e.disabled=!0}function d(t){const e=o(t);e.disabled=!1}class y{id;name;description;constructor(e,n,s){this.id=e,this.name=n,this.description=s}static fromJSON(e){const n=JSON.parse(e);if(!n.id)throw new Error("Missing required property: id");if(!n.name)throw new Error("Missing required property: name");if(!n.description)throw new Error("Missing required property: description");return new y(n.id,n.name,n.description)}}class l{static _instance;api_key;name;agent_names;static initFromDOM(){const e=document.querySelector("#user-api-key"),n=o("#user-name"),s=o("#user-agent-name");let r=[];for(const i of Array.from(s.children)){const c=i;r.push(c.value)}return new l(e.value,n.value,r)}constructor(e,n,s){if(l._instance)throw new Error("Error: User singleton already initialized.");this.api_key=e,this.name=n,this.agent_names=s,l._instance=this}static getInstance(){if(!l._instance)throw new Error("Error: User singleton not initialized.");return l._instance}}class a{static _instance;user;agent;abortController;static initFromDOM(){const e=l.initFromDOM();return new a(e)}constructor(e){if(a._instance)throw new Error("Error: API singleton already initialized.");this.user=e,a._instance=this}static getInstance(){if(!a._instance)throw new Error("Error: API singleton not initialized.");return a._instance}abort(){this.abortController?.abort(),this.abortController=void 0}}function S(){if(document.querySelector("#user-session")==null){h("Session not initiated.","Did you load from dist?"),g("#error-dismiss-button");return}const t=a.initFromDOM();let e=o("#newchat-agent-select");t.user.agent_names.forEach(n=>{let s=document.createElement("option");s.value=n,s.innerText=n,e.appendChild(s)}),o("#greeting").innerText=`Hello, ${t.user.name}!`,u("#chat-cancel-button"),o("#prompt-textarea").addEventListener("focus",function(){this.select()}),o("#prompt-textarea").addEventListener("keydown",A),o("#error-dismiss-button").addEventListener("click",q),o("#newchat-button").addEventListener("click",P),o("#reset-key-button").addEventListener("click",k),o("#chat-clear-button").addEventListener("click",b),o("#chat-cancel-button").addEventListener("click",E),f("#newchat")}async function L(t){const e=a.getInstance();e.abort(),u("#prompt-textarea"),d("#chat-cancel-button"),O(t),T(),e.abortController=new AbortController;try{const n=await fetch(`/v1/agents/${e.agent.id}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.user.api_key},body:JSON.stringify({prompt:t}),signal:e.abortController.signal});if(d("#prompt-textarea"),u("#chat-cancel-button"),m(),e.abortController=void 0,!n.ok){const i=await n.text();h(`${n.status} ${n.statusText}`,i),p("Error running completion.");return}const s=await n.json();_(s.completion);const r=o("#prompt-textarea");r.value="",v(r),r.focus()}catch(n){if(e.abortController=void 0,d("#prompt-textarea"),u("#chat-cancel-button"),m(),n instanceof Error&&n.name==="AbortError"){p("User canceled completion.");return}const s=n instanceof Error?n.message:String(n);h("Request failed",s),p("Error running completion.")}}function p(t){w(t,"system")}function O(t){w(t,"user")}function _(t){w(t,"agent")}function w(t,e){const n=document.createElement("div");n.classList.add(e),n.innerText=t,o("#history").appendChild(n),$()}function b(){o("#history").innerHTML=""}function E(){a.getInstance().abort()}async function P(){if(document.querySelectorAll("#history .user").length>0&&confirm("Clear chat history and start fresh?")==!1)return;E();const e=a.getInstance();g("#chat"),u("#newchat-agent-select"),u("#newchat-button");const s=o("#newchat-agent-select").value;try{T();const r=await fetch("/v1/agents/new",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.user.api_key},body:JSON.stringify({agent:s})});if(d("#newchat-agent-select"),d("#newchat-button"),m(),!r.ok){e.agent&&f("#chat");const x=await r.text();h(`${r.status} ${r.statusText}`,x);return}const i=await r.json(),c=new y(i.id,i.name,i.description);e.agent=c,M(c)}catch(r){d("#newchat-agent-select"),d("#newchat-button"),e.agent&&f("#chat"),m(),h("Request failed",r instanceof Error?r.message:String(r))}}function M(t){b();let e=`You are chatting with ${t.name}`;t.description==""?e+=".":e+=`: ${t.description}`,p(e),f("#chat")}function k(t){t.preventDefault(),confirm("Clear chat history and reset API Key?")==!0&&(window.location.href="/v1/ui")}function h(t,e){o("#error-message").innerText=t,o("#error-detail").innerText=e,f("#error")}function q(){o("#error-message").innerText="Error.",o("#error-detail").innerText="An error occurred.",g("#error")}function v(t){t.style.height,t.style.height="auto";const e=window.getComputedStyle(t),n=parseFloat(e.paddingTop),s=parseFloat(e.paddingBottom),r=n+s,i=t.scrollHeight-r+"px";t.style.height=i,t.style.height=t.scrollHeight+10+"px"}function $(){window.scrollTo({top:document.documentElement.scrollHeight,behavior:"smooth"})}function A(t){if(t.defaultPrevented)return;let e=t.target;if(v(e),t.key==="Enter"&&!t.shiftKey){t.preventDefault();let n=e.value;if(!n.match(/\S/)){C(e);return}L(n)}}function T(){f("#progress");let t=o("#spinner"),e=3;t.style.transformOrigin="center",t.style.animation=`spin ${e}s linear infinite`}function m(){g("#progress");let t=o("#spinner");const n=window.getComputedStyle(t).getPropertyValue("transform");t.style.animation="none",n!=="none"&&(t.style.transform=n)}document.addEventListener("DOMContentLoaded",S);</script>
    <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;display:flex;min-height:100vh;padding-top:10px;text-align:center}#main-content{min-width:60%;margin:0 auto}#prompt-entry{margin-top:20px}#prompt-entry label{font-weight:700;font-size:1.2em;margin-top:11px;margin-right:5px;display:inline-block;vertical-align:top}#prompt-textarea{resize:none;overflow:hidden;width:70%;height:auto;min-height:40px;font:sans-serif;font-size:1.2em;text-align:left;padding:10px;display:inline-block;vertical-align:top;background:#eee;border:1px solid black;margin-bottom:10px}#prompt-textarea.flash{border:1px solid red;background:#ffc}#progress{margin:20px auto}#history{margin:20px auto;width:100%}#history div{font-family:serif;text-align:left;font-size:1.2em;margin-bottom:10px}#history div.system{color:red;font-style:italic;padding-bottom:5px;border-bottom:1px dashed #ccc}#history div.user{color:#00f}#history div.agent{color:orange}#chat-controls{padding-bottom:10px;border-bottom:2px solid black}#newchat{margin:20px auto;font-size:1.2em;border-top:2px solid black;padding-top:20px}select,::picker(select){appearance:base-select}select{font-size:1em;padding-left:5px;padding-right:5px}button{font-size:inherit;padding-left:5px;padding-right:5px;margin-left:10px}.hidden{display:none}#error{background:#ffc;border:4px solid black;width:70%;text-align:left;font-size:1em;margin:0 auto;padding:10px}#error-message{color:red;font-size:1.2em}#error-detail{color:#000;margin-top:10px}#reset-key{margin:20px auto}.controls{text-align:right}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}</style>
  </head>
  <body>
    <!-- Main Content -->
    <div id="main-content">
      <h1>Greenhead Simple Chat</h1>
      <h2 id="greeting"></h2>
      <div id="error" class="hidden">
        <h2 id="error-message">Error</h2>
        <div id="error-detail">An error occurred.</div>
        <div id="error-controls" class="controls">
          <button id="error-dismiss-button">Dismiss</button>
        </div>
      </div>
      <div id="chat" class="hidden">
        <div id="history"></div>
        <div id="chat-controls" class="controls">
          <button id="chat-clear-button">Clear</button>
          <button id="chat-cancel-button">Cancel</button>
        </div>
        <div id="prompt-entry">
          <label for="prompt-textarea">Prompt:</label>
          <textarea id="prompt-textarea">
You're in a desert, walking along in the sand when all of the sudden you look down and you see a tortoise.</textarea
          >
          <p>
            Press <strong>Return</strong> to send;
            <strong>Shift-Return</strong> for newline.
          </p>
        </div>
      </div>
      <div id="newchat" class="hidden">
        Choose agent:
        <select id="newchat-agent-select"></select>
        <button id="newchat-button">New Chat</button>
      </div>
      <div id="reset-key">
        <button id="reset-key-button">Reset API Key</button>
      </div>
      <div id="progress" class="hidden">
        <svg
          id="spinner"
          width="50"
          height="50"
          viewBox="0 0 100 100"
          xmlns="http://www.w3.org/2000/svg"
        >
          <!-- Outer circle -->
          <circle
            cx="50"
            cy="50"
            r="45"
            fill="white"
            stroke="black"
            stroke-width="2"
          />

          <!-- Main halves -->
          <path
            d="M50,5 A45,45 0 0,0 50,95 A22.5,22.5 0 0,1 50,50 A22.5,22.5 0 0,0 50,5"
            fill="black"
          />

          <!-- Small circles -->
          <circle cx="50" cy="27.5" r="5" fill="white" />
          <circle cx="50" cy="72.5" r="5" fill="black" />
        </svg>
      </div>
    </div>
  </body>
</html>
